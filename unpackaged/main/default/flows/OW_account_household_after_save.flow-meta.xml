<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>52.0</apiVersion>
    <assignments>
        <name>Add_advice_to_collection</name>
        <label>Add advice to collection</label>
        <locationX>358</locationX>
        <locationY>1463</locationY>
        <assignmentItems>
            <assignToReference>adviceToUpdate</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>Loop_through_advice</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_through_advice</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_advice_to_collectionProfile</name>
        <label>Add advice to collection</label>
        <locationX>358</locationX>
        <locationY>2879</locationY>
        <assignmentItems>
            <assignToReference>adviceToUpdate</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>Loop_through_adviceProfile</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_through_adviceProfile</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Add_advice_to_collectionProfileSent</name>
        <label>Add advice to collection</label>
        <locationX>358</locationX>
        <locationY>2171</locationY>
        <assignmentItems>
            <assignToReference>adviceToUpdate</assignToReference>
            <operator>Add</operator>
            <value>
                <elementReference>Loop_through_adviceProfileSent</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Loop_through_adviceProfileSent</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_to_specialist_team_A</name>
        <label>Assign to specialist team A</label>
        <locationX>50</locationX>
        <locationY>539</locationY>
        <assignmentItems>
            <assignToReference>$Record.OW_queue__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>OperationsTeamA</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Set_household_name</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_to_specialist_team_B</name>
        <label>Assign to specialist team B</label>
        <locationX>314</locationX>
        <locationY>539</locationY>
        <assignmentItems>
            <assignToReference>$Record.OW_queue__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>OperationsTeamB</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Set_household_name</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Set_household_name</name>
        <label>Set household name</label>
        <locationX>94</locationX>
        <locationY>731</locationY>
        <assignmentItems>
            <assignToReference>$Record.Name</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>{!$Record.Account_ID__c} {!$Record.Name}</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_household</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Update_advice_values</name>
        <label>Update advice values</label>
        <locationX>358</locationX>
        <locationY>1355</locationY>
        <assignmentItems>
            <assignToReference>Loop_through_advice.RtqStatus__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Complete</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_advice_to_collection</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Update_advice_valuesProfile</name>
        <label>Update advice values</label>
        <locationX>358</locationX>
        <locationY>2771</locationY>
        <assignmentItems>
            <assignToReference>Loop_through_adviceProfile.ProfileUpdateStatus__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Complete</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_advice_to_collectionProfile</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Update_advice_valuesProfileSent</name>
        <label>Update advice values</label>
        <locationX>358</locationX>
        <locationY>2063</locationY>
        <assignmentItems>
            <assignToReference>Loop_through_adviceProfileSent.ProfileUpdateStatus__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>In progress</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Add_advice_to_collectionProfileSent</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Advice_to_update</name>
        <label>Advice to update?</label>
        <locationX>402</locationX>
        <locationY>3155</locationY>
        <defaultConnector>
            <targetReference>Customer_flag_update_needed</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>YesAdviceUpdateNeeded</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>adviceToUpdate</leftValueReference>
                <operator>IsEmpty</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_advice</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <description>Checks if a customer flag was set on a new household or changed on an existing one.</description>
        <name>Customer_flag_update_needed</name>
        <label>Customer flag update needed?</label>
        <locationX>402</locationX>
        <locationY>3455</locationY>
        <defaultConnectorLabel>No customer flag update needed</defaultConnectorLabel>
        <rules>
            <name>Customer_flag_set_or_updated</name>
            <conditionLogic>( 1 OR ( 2 AND 3 ) ) AND 4</conditionLogic>
            <conditions>
                <leftValueReference>$Record.OW_customer_flag__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>is_new</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.OW_customer_flag__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>false</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.RecordType.DeveloperName</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>IndustriesHousehold</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Update_linked_person_accounts</targetReference>
            </connector>
            <label>Customer flag set or updated</label>
        </rules>
    </decisions>
    <decisions>
        <description>Routes for assignment to either team 1 or 2 depending on whether the account number is even or not.</description>
        <name>Even_account_number</name>
        <label>Even account number</label>
        <locationX>94</locationX>
        <locationY>431</locationY>
        <defaultConnector>
            <targetReference>Assign_to_specialist_team_B</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Odd</defaultConnectorLabel>
        <rules>
            <name>OMHousehold</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.GroupCompany__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>OM</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Set_household_name</targetReference>
            </connector>
            <label>OM Household</label>
        </rules>
        <rules>
            <name>Even</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>account_number_even</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_to_specialist_team_A</targetReference>
            </connector>
            <label>Even</label>
        </rules>
    </decisions>
    <decisions>
        <name>New_household</name>
        <label>New household?</label>
        <locationX>402</locationX>
        <locationY>323</locationY>
        <defaultConnector>
            <targetReference>Ready_for_RTQ</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Existing</defaultConnectorLabel>
        <rules>
            <name>New</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>is_new</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Even_account_number</targetReference>
            </connector>
            <label>New</label>
        </rules>
    </decisions>
    <decisions>
        <name>Profile_complete</name>
        <label>Profile complete?</label>
        <locationX>402</locationX>
        <locationY>2447</locationY>
        <defaultConnector>
            <targetReference>Advice_to_update</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>YesProfileComplete</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Profile_Status__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Up-to-date</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_advice_awaiting_profile_update</targetReference>
            </connector>
            <doesRequireRecordChangedToMeetCriteria>true</doesRequireRecordChangedToMeetCriteria>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Profile_sent</name>
        <label>Profile sent?</label>
        <locationX>402</locationX>
        <locationY>1739</locationY>
        <defaultConnector>
            <targetReference>Profile_complete</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>YesProfileSent</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Profile_Status__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Sent to Client(s)</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_advice_awaiting_profile_send</targetReference>
            </connector>
            <doesRequireRecordChangedToMeetCriteria>true</doesRequireRecordChangedToMeetCriteria>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>Ready_for_RTQ</name>
        <label>Ready for RTQ?</label>
        <locationX>710</locationX>
        <locationY>431</locationY>
        <defaultConnector>
            <targetReference>RTQs_complete</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Yes</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.Profile_Status__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Up-to-date</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.FinServ__Status__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Onboarding</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.OW_rtq_status__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Incomplete</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Create_RTQs</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <decisions>
        <name>RTQs_complete</name>
        <label>RTQs complete?</label>
        <locationX>402</locationX>
        <locationY>1031</locationY>
        <defaultConnector>
            <targetReference>Profile_sent</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>YesRtqsComplete</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>$Record.OW_rtq_status__c</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Complete</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_advice_with_outstanding_RTQ_status</targetReference>
            </connector>
            <doesRequireRecordChangedToMeetCriteria>true</doesRequireRecordChangedToMeetCriteria>
            <label>Yes</label>
        </rules>
    </decisions>
    <description>After save record triggered flow for the account object to cover household related triggers.</description>
    <environments>Default</environments>
    <formulas>
        <description>Checks if the auto-generated account number for this account is even, returning true if so.</description>
        <name>account_number_even</name>
        <dataType>Boolean</dataType>
        <expression>MOD( VALUE( RIGHT( {!$Record.Account_ID__c}, 1) ), 2 ) = 0</expression>
    </formulas>
    <formulas>
        <description>Returns true if this is a new record</description>
        <name>is_new</name>
        <dataType>Boolean</dataType>
        <expression>ISNEW()</expression>
    </formulas>
    <interviewLabel>Account - household - after save flow {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Account - household - after save</label>
    <loops>
        <name>Loop_through_advice</name>
        <label>Loop through advice</label>
        <locationX>270</locationX>
        <locationY>1247</locationY>
        <collectionReference>Get_advice_with_outstanding_RTQ_status</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Update_advice_values</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Profile_sent</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>Loop_through_adviceProfile</name>
        <label>Loop through advice</label>
        <locationX>270</locationX>
        <locationY>2663</locationY>
        <collectionReference>Get_advice_awaiting_profile_update</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Update_advice_valuesProfile</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Advice_to_update</targetReference>
        </noMoreValuesConnector>
    </loops>
    <loops>
        <name>Loop_through_adviceProfileSent</name>
        <label>Loop through advice</label>
        <locationX>270</locationX>
        <locationY>1955</locationY>
        <collectionReference>Get_advice_awaiting_profile_send</collectionReference>
        <iterationOrder>Asc</iterationOrder>
        <nextValueConnector>
            <targetReference>Update_advice_valuesProfileSent</targetReference>
        </nextValueConnector>
        <noMoreValuesConnector>
            <targetReference>Profile_complete</targetReference>
        </noMoreValuesConnector>
    </loops>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <name>Get_advice_awaiting_profile_send</name>
        <label>Get advice awaiting profile send</label>
        <locationX>270</locationX>
        <locationY>1847</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Loop_through_adviceProfileSent</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Advice_Household__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>ProfileUpdateStatus__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>Not started</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>Advice__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_advice_awaiting_profile_update</name>
        <label>Get advice awaiting profile update</label>
        <locationX>270</locationX>
        <locationY>2555</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Loop_through_adviceProfile</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Advice_Household__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>ProfileUpdateStatus__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>In progress</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>Advice__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordLookups>
        <name>Get_advice_with_outstanding_RTQ_status</name>
        <label>Get advice with outstanding RTQ status</label>
        <locationX>270</locationX>
        <locationY>1139</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Loop_through_advice</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Advice_Household__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <filters>
            <field>RtqStatus__c</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>In progress</stringValue>
            </value>
        </filters>
        <getFirstRecordOnly>false</getFirstRecordOnly>
        <object>Advice__c</object>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>Update_advice</name>
        <label>Update advice</label>
        <locationX>270</locationX>
        <locationY>3263</locationY>
        <connector>
            <targetReference>Customer_flag_update_needed</targetReference>
        </connector>
        <inputReference>adviceToUpdate</inputReference>
    </recordUpdates>
    <recordUpdates>
        <name>Update_household</name>
        <label>Update household</label>
        <locationX>94</locationX>
        <locationY>839</locationY>
        <connector>
            <targetReference>RTQs_complete</targetReference>
        </connector>
        <inputReference>$Record</inputReference>
    </recordUpdates>
    <recordUpdates>
        <description>Udpate the person accounts linked to this household to set the same customer flag on them.</description>
        <name>Update_linked_person_accounts</name>
        <label>Update linked person accounts</label>
        <locationX>270</locationX>
        <locationY>3563</locationY>
        <filterLogic>and</filterLogic>
        <filters>
            <field>IsPersonAccount</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <filters>
            <field>Household_Lookup__c</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </filters>
        <inputAssignments>
            <field>OW_customer_flag__c</field>
            <value>
                <elementReference>$Record.OW_customer_flag__c</elementReference>
            </value>
        </inputAssignments>
        <object>Account</object>
    </recordUpdates>
    <start>
        <locationX>276</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>New_household</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>RecordTypeId</field>
            <operator>EqualTo</operator>
            <value>
                <stringValue>0121t000000vGIyAAM</stringValue>
            </value>
        </filters>
        <object>Account</object>
        <recordTriggerType>CreateAndUpdate</recordTriggerType>
        <triggerType>RecordAfterSave</triggerType>
    </start>
    <status>Active</status>
    <subflows>
        <name>Create_RTQs</name>
        <label>Create RTQs</label>
        <locationX>578</locationX>
        <locationY>539</locationY>
        <connector>
            <targetReference>RTQs_complete</targetReference>
        </connector>
        <flowName>OW_create_rtq</flowName>
        <inputAssignments>
            <name>household_id</name>
            <value>
                <elementReference>$Record.Id</elementReference>
            </value>
        </inputAssignments>
    </subflows>
    <variables>
        <name>adviceToUpdate</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Advice__c</objectType>
    </variables>
</Flow>
