<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>55.0</apiVersion>
    <assignments>
        <name>Set_new_household_values</name>
        <label>Set new household values</label>
        <locationX>50</locationX>
        <locationY>518</locationY>
        <assignmentItems>
            <assignToReference>Get_Household_Details.FinServ__NextReview__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>nextReviewDate</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>Get_Household_Details.OW_annual_review_month__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>reviewMonth</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>Get_Household_Details.Stop_Internal_User_Update__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>stopInternalUserUpdate</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_household_review</targetReference>
        </connector>
    </assignments>
    <decisions>
        <name>Has_permission_to_manage_annual_review_month</name>
        <label>Has permission to manage annual review month?</label>
        <locationX>182</locationX>
        <locationY>158</locationY>
        <defaultConnector>
            <targetReference>Error</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Planner</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>$Permission.AccountManageAnnualReviewMonth</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_Household_Details</targetReference>
            </connector>
            <label>Planner</label>
        </rules>
    </decisions>
    <description>This flow allows a user to move the date/month of a customer&#39;s next annual review. It also checks at the beginning to ensure that only people on specific profiles can do this.</description>
    <environments>Default</environments>
    <formulas>
        <name>nextReviewDate</name>
        <dataType>Date</dataType>
        <expression>DATE(YEAR({!OW_annual_review_date}), MONTH({!OW_annual_review_date}), 1)</expression>
    </formulas>
    <formulas>
        <description>The month and year of the next review in string format for output to the user.</description>
        <name>nextReviewString</name>
        <dataType>String</dataType>
        <expression>CASE(MONTH({!Get_Household_Details.FinServ__NextReview__c}),
1, &quot;January&quot;,
2, &quot;February&quot;,
3, &quot;March&quot;, 
4, &quot;April&quot;, 
5, &quot;May&quot;, 
6, &quot;June&quot;,
7, &quot;July&quot;,
8, &quot;August&quot;,
9, &quot;September&quot;,
10, &quot;October&quot;,
11, &quot;November&quot;,
12, &quot;December&quot;,
&quot;None&quot;) &amp; &quot; &quot; &amp; TEXT( YEAR( {!Get_Household_Details.FinServ__NextReview__c}))</expression>
    </formulas>
    <formulas>
        <name>reviewMonth</name>
        <dataType>String</dataType>
        <expression>TEXT( MONTH( {!OW_annual_review_date} ))</expression>
    </formulas>
    <formulas>
        <name>stopInternalUserUpdate</name>
        <dataType>Number</dataType>
        <expression>IF(ISBLANK({!Get_Household_Details.Stop_Internal_User_Update__c}),1,{!Get_Household_Details.Stop_Internal_User_Update__c}+1)</expression>
        <scale>0</scale>
    </formulas>
    <interviewLabel>Account | Annual review date change {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Account | Annual review date change</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>Flow</processType>
    <recordLookups>
        <name>Get_Household_Details</name>
        <label>Get Household Details</label>
        <locationX>50</locationX>
        <locationY>278</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>OW_new_annual_review_date</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>Id</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>recordId</elementReference>
            </value>
        </filters>
        <getFirstRecordOnly>true</getFirstRecordOnly>
        <object>Account</object>
        <queriedFields>Id</queriedFields>
        <queriedFields>Stop_Internal_User_Update__c</queriedFields>
        <queriedFields>OW_annual_review_month__c</queriedFields>
        <queriedFields>FinServ__NextReview__c</queriedFields>
        <storeOutputAutomatically>true</storeOutputAutomatically>
    </recordLookups>
    <recordUpdates>
        <name>Update_household_review</name>
        <label>Update household review</label>
        <locationX>50</locationX>
        <locationY>638</locationY>
        <connector>
            <targetReference>Success_screen</targetReference>
        </connector>
        <inputReference>Get_Household_Details</inputReference>
    </recordUpdates>
    <screens>
        <name>Error</name>
        <label>Error</label>
        <locationX>314</locationX>
        <locationY>278</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>true</allowPause>
        <fields>
            <name>errorMessage</name>
            <fieldText>&lt;p&gt;You do not have access to change customer annual reviews. &lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>false</showHeader>
    </screens>
    <screens>
        <name>OW_new_annual_review_date</name>
        <label>New annual review date</label>
        <locationX>50</locationX>
        <locationY>398</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>true</allowPause>
        <connector>
            <targetReference>Set_new_household_values</targetReference>
        </connector>
        <fields>
            <name>PromptTextReviewSet</name>
            <fieldText>&lt;p&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(0, 0, 0);&quot;&gt;The next review is scheduled for {!nextReviewString} and will be created ~{!$Setup.OW_business_configuration__c.OW_annual_review_lead_time__c} days ahead of this. &lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;If you wish to change when the next annual review will occur, please set a new date below.&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;Please ensure that any changes are in line with our customer and regulatory commitments to provide regular reviews.&lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;span style=&quot;color: rgb(0, 0, 0);&quot;&gt;Note that this process doesn&#39;t consider any open reviews.&lt;/span&gt;&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
            <visibilityRule>
                <conditionLogic>and</conditionLogic>
                <conditions>
                    <leftValueReference>Get_Household_Details.FinServ__NextReview__c</leftValueReference>
                    <operator>IsNull</operator>
                    <rightValue>
                        <booleanValue>false</booleanValue>
                    </rightValue>
                </conditions>
            </visibilityRule>
        </fields>
        <fields>
            <name>PromptTextReviewNotSet</name>
            <fieldText>&lt;p&gt;This customer does not yet have an annual review and setting one will mean the review is not tied to when they become an active customer (when fulfilment first completes for them).&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;Please proceed if you understand this. &lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
            <visibilityRule>
                <conditionLogic>and</conditionLogic>
                <conditions>
                    <leftValueReference>Get_Household_Details.FinServ__NextReview__c</leftValueReference>
                    <operator>IsNull</operator>
                    <rightValue>
                        <booleanValue>true</booleanValue>
                    </rightValue>
                </conditions>
            </visibilityRule>
        </fields>
        <fields>
            <name>OW_annual_review_date</name>
            <dataType>Date</dataType>
            <fieldText>Annual review date</fieldText>
            <fieldType>InputField</fieldType>
            <isRequired>true</isRequired>
            <validationRule>
                <errorMessage>&lt;p&gt;Annual review date cannot be in the past.&lt;/p&gt;</errorMessage>
                <formulaExpression>{!OW_annual_review_date}&gt;=Today()</formulaExpression>
            </validationRule>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <screens>
        <name>Success_screen</name>
        <label>Success screen</label>
        <locationX>50</locationX>
        <locationY>758</locationY>
        <allowBack>true</allowBack>
        <allowFinish>true</allowFinish>
        <allowPause>true</allowPause>
        <fields>
            <name>SuccessMessage</name>
            <fieldText>&lt;p&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(68, 68, 68);&quot;&gt;All done! The next review will generate shortly ahead of {!nextReviewString}. &lt;/span&gt;&lt;/p&gt;&lt;p&gt;&lt;br&gt;&lt;/p&gt;&lt;p&gt;&lt;span style=&quot;background-color: rgb(255, 255, 255); color: rgb(68, 68, 68);&quot;&gt;As a reminder, reviews generate in an overnight process so if the next review is not too far in the future, it&#39;ll still be at least until tomorrow that this is generated. &lt;/span&gt;&lt;/p&gt;</fieldText>
            <fieldType>DisplayText</fieldType>
        </fields>
        <showFooter>true</showFooter>
        <showHeader>true</showHeader>
    </screens>
    <start>
        <locationX>56</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Has_permission_to_manage_annual_review_month</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <variables>
        <name>AnnualReview</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>OW_review__c</objectType>
    </variables>
    <variables>
        <name>recordId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
