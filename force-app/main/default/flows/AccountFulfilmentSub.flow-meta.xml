<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>61.0</apiVersion>
    <assignments>
        <description>Sets the review dates for the household.</description>
        <name>Set_the_review_dates_0</name>
        <label>Set the review dates</label>
        <locationX>50</locationX>
        <locationY>242</locationY>
        <assignmentItems>
            <assignToReference>household.FinServ__NextReview__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>nextReviewDate</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>household.OW_annual_review_month__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>annualReviewMonthText</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>household.Id</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>fulfilment.Household__c</elementReference>
            </value>
        </assignmentItems>
        <assignmentItems>
            <assignToReference>household.Stop_Internal_User_Update__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>stopInternalUserUpdate</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Update_household_0</targetReference>
        </connector>
    </assignments>
    <decisions>
        <description>Checks when a fulfilment is complete whether a next review date is set and sets one if not. This ensures the first fulfilment will set the annual review schedule unless one has already been established by the partner.</description>
        <name>Review_date_needed</name>
        <label>Review date needed?</label>
        <locationX>182</locationX>
        <locationY>134</locationY>
        <defaultConnectorLabel>Review date not needed</defaultConnectorLabel>
        <rules>
            <name>Review_date_needed_decision</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>fulfilment.Household__r.FinServ__NextReview__c</leftValueReference>
                <operator>IsNull</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Set_the_review_dates_0</targetReference>
            </connector>
            <label>Review date needed</label>
        </rules>
    </decisions>
    <description>Marked as unused when we moved the logic to set the review date to when the advice meeting took place. 

Sub flow to update review dates on accounts when v3 fulfilment is completed. This is called by the Fulfilment | complete flow, which runs on the new fulfilment object.</description>
    <environments>Default</environments>
    <formulas>
        <description>The month for which the customer&#39;s annual will be scheduled.</description>
        <name>annualReviewMonth</name>
        <dataType>Number</dataType>
        <expression>CASE( MONTH(TODAY()), 
1, 12,
2, 4,
3, 5,
MONTH(TODAY()))</expression>
        <scale>0</scale>
    </formulas>
    <formulas>
        <description>The month this client will get their annual review in stored as a text value of the number.</description>
        <name>annualReviewMonthText</name>
        <dataType>String</dataType>
        <expression>TEXT({!annualReviewMonth})</expression>
    </formulas>
    <formulas>
        <description>The next year this customer will get an annual review.</description>
        <name>nextAnnualReviewYear</name>
        <dataType>Number</dataType>
        <expression>CASE(MONTH(TODAY()), 
1, YEAR(TODAY()),
YEAR(TODAY()) + 1)</expression>
        <scale>0</scale>
    </formulas>
    <formulas>
        <description>The first review date for the household, combining the review month and next review year.</description>
        <name>nextReviewDate</name>
        <dataType>Date</dataType>
        <expression>DATE({!nextAnnualReviewYear}, {!annualReviewMonth}, 1)</expression>
    </formulas>
    <formulas>
        <name>stopInternalUserUpdate</name>
        <dataType>Number</dataType>
        <expression>IF ( ISBLANK( {!fulfilment.Household__r.Stop_Internal_User_Update__c} ),
    1,
    1 + {!fulfilment.Household__r.Stop_Internal_User_Update__c}
)</expression>
        <scale>0</scale>
    </formulas>
    <interviewLabel>Account | Fulfilment sub {!$Flow.CurrentDateTime}</interviewLabel>
    <isTemplate>true</isTemplate>
    <label>zUnused | Account | Fulfilment sub (V3)</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordUpdates>
        <description>Update the household record related to this fulfilment.</description>
        <name>Update_household_0</name>
        <label>Update household</label>
        <locationX>50</locationX>
        <locationY>350</locationY>
        <inputReference>household</inputReference>
    </recordUpdates>
    <start>
        <locationX>56</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Review_date_needed</targetReference>
        </connector>
    </start>
    <status>Obsolete</status>
    <variables>
        <name>fulfilment</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
        <objectType>Fulfilment__c</objectType>
    </variables>
    <variables>
        <description>Stores updated values for the household to be committed in an update operation at the end of the flow.</description>
        <name>household</name>
        <dataType>SObject</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
        <objectType>Account</objectType>
    </variables>
</Flow>
