<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <actionCalls>
        <name>Get_person_account_record_type_ID</name>
        <label>Get person account record type ID</label>
        <locationX>446</locationX>
        <locationY>650</locationY>
        <actionName>FlowUtilityGetRecordTypeId</actionName>
        <actionType>apex</actionType>
        <connector>
            <targetReference>Client_referral</targetReference>
        </connector>
        <flowTransactionModel>CurrentTransaction</flowTransactionModel>
        <inputParameters>
            <name>recordTypeDeveloperName</name>
            <value>
                <elementReference>RecordTypeDeveloperName</elementReference>
            </value>
        </inputParameters>
        <inputParameters>
            <name>sObjectType</name>
            <value>
                <stringValue>Account</stringValue>
            </value>
        </inputParameters>
        <nameSegment>FlowUtilityGetRecordTypeId</nameSegment>
        <offset>0</offset>
        <outputParameters>
            <assignToReference>accountRecordTypeId</assignToReference>
            <name>recordTypeId</name>
        </outputParameters>
    </actionCalls>
    <apiVersion>63.0</apiVersion>
    <assignments>
        <name>Assign_business_account</name>
        <label>Assign business account</label>
        <locationX>578</locationX>
        <locationY>350</locationY>
        <assignmentItems>
            <assignToReference>RecordTypeDeveloperName</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>OW_business</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Get_person_account_record_type_ID</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_colleague_record_type</name>
        <label>Assign colleague record type</label>
        <locationX>314</locationX>
        <locationY>350</locationY>
        <assignmentItems>
            <assignToReference>RecordTypeDeveloperName</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Colleague</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Get_person_account_record_type_ID</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Assign_format_error</name>
        <label>Assign format error</label>
        <locationX>1106</locationX>
        <locationY>242</locationY>
        <assignmentItems>
            <assignToReference>displayMessage</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>All mobile numbers must be in the correct format with a country code e.g. +447123456789 with no spaces or symbols</stringValue>
            </value>
        </assignmentItems>
    </assignments>
    <assignments>
        <name>Assign_person_account_record_type</name>
        <label>Assign person account record type</label>
        <locationX>50</locationX>
        <locationY>350</locationY>
        <assignmentItems>
            <assignToReference>RecordTypeDeveloperName</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>PersonAccount</stringValue>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Get_person_account_record_type_ID</targetReference>
        </connector>
    </assignments>
    <assignments>
        <name>Clear_display_message</name>
        <label>Clear display message</label>
        <locationX>578</locationX>
        <locationY>1166</locationY>
        <assignmentItems>
            <assignToReference>displayMessage</assignToReference>
            <operator>Assign</operator>
        </assignmentItems>
    </assignments>
    <assignments>
        <name>Display_type_not_found_message</name>
        <label>Display type not found message</label>
        <locationX>842</locationX>
        <locationY>350</locationY>
        <assignmentItems>
            <assignToReference>displayMessage</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>A referrer isn&#39;t required on the lead source selected. Please raise a Salesforce ticket </stringValue>
            </value>
        </assignmentItems>
    </assignments>
    <assignments>
        <name>Set_error_message</name>
        <label>Set error message</label>
        <locationX>314</locationX>
        <locationY>1166</locationY>
        <assignmentItems>
            <assignToReference>displayMessage</assignToReference>
            <operator>Assign</operator>
            <value>
                <stringValue>Nobody found with those details.</stringValue>
            </value>
        </assignmentItems>
    </assignments>
    <decisions>
        <name>Any_records_found</name>
        <label>Any records found</label>
        <locationX>446</locationX>
        <locationY>1058</locationY>
        <defaultConnector>
            <targetReference>Clear_display_message</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Records found</defaultConnectorLabel>
        <rules>
            <name>No_records_found</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>referrerOptions</leftValueReference>
                <operator>IsEmpty</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Set_error_message</targetReference>
            </connector>
            <label>No records found</label>
        </rules>
    </decisions>
    <decisions>
        <name>Client_referral</name>
        <label>Client referral</label>
        <locationX>446</locationX>
        <locationY>758</locationY>
        <defaultConnector>
            <targetReference>Get_other_accounts</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Other record type search</defaultConnectorLabel>
        <rules>
            <name>Client_search</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>RecordTypeDeveloperName</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>PersonAccount</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Get_person_accounts</targetReference>
            </connector>
            <label>Client search</label>
        </rules>
    </decisions>
    <decisions>
        <description>Decision to check 
- is user searching on mobile?
- does mobile start with area code?
-does mobil have correct number of characters?</description>
        <name>Is_mobile_in_valid_format</name>
        <label>Is mobile in valid format?</label>
        <locationX>776</locationX>
        <locationY>134</locationY>
        <defaultConnector>
            <targetReference>Assign_format_error</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Mobile format invalid</defaultConnectorLabel>
        <rules>
            <name>Mobile_format_valid</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>mobileValidFormatCheck</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Type_of_referral</targetReference>
            </connector>
            <label>Mobile format valid</label>
        </rules>
    </decisions>
    <decisions>
        <name>Type_of_referral</name>
        <label>Type of referral?</label>
        <locationX>446</locationX>
        <locationY>242</locationY>
        <defaultConnector>
            <targetReference>Display_type_not_found_message</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>Not defined</defaultConnectorLabel>
        <rules>
            <name>Client_or_Introducer</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>referralType</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Client Referral</stringValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>referralType</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Introducer</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_person_account_record_type</targetReference>
            </connector>
            <label>Client or Introducer</label>
        </rules>
        <rules>
            <name>Colleague</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>referralType</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Employee Referral</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_colleague_record_type</targetReference>
            </connector>
            <label>Colleague</label>
        </rules>
        <rules>
            <name>Business</name>
            <conditionLogic>and</conditionLogic>
            <conditions>
                <leftValueReference>referralType</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <stringValue>Financial Wellbeing Rollout</stringValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Assign_business_account</targetReference>
            </connector>
            <label>Business</label>
        </rules>
    </decisions>
    <description>Flow to search for a person who passed on the referral. Flow accepts a string value to search on, and this flow returns a list of people who match on either email, phone or name of the person returned.</description>
    <environments>Default</environments>
    <formulas>
        <description>IF(ISNUMBER({!searchString})
&amp;&amp;
IF(BEGINS({!searchString}, &quot;+44&quot;), 
REGEX({!searchString}, &quot;^\\+447\\d{9}$&quot;), 
REGEX({!searchString}, &quot;^\\+[1-9]\\d{6,13}$&quot;)), true, false
)</description>
        <name>mobileValidFormatCheck</name>
        <dataType>Boolean</dataType>
        <expression>IF(NOT(ISNUMBER({!searchString}))
||
IF(BEGINS({!searchString}, &quot;+44&quot;), 
REGEX({!searchString}, &quot;^\\+447\\d{9}$&quot;), 
REGEX({!searchString}, &quot;^\\+[1-9]\\d{6,13}$&quot;)), true, false
)</expression>
    </formulas>
    <interviewLabel>Lead | Get referrer {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Lead | Get referrer</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <recordLookups>
        <name>Get_other_accounts</name>
        <label>Get other accounts</label>
        <locationX>578</locationX>
        <locationY>866</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Any_records_found</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>RecordTypeId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>accountRecordTypeId</elementReference>
            </value>
        </filters>
        <filters>
            <field>Name</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>searchString</elementReference>
            </value>
        </filters>
        <object>Account</object>
        <outputReference>referrerOptions</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Name</queriedFields>
    </recordLookups>
    <recordLookups>
        <name>Get_person_accounts</name>
        <label>Get person accounts</label>
        <locationX>314</locationX>
        <locationY>866</locationY>
        <assignNullValuesIfNoRecordsFound>false</assignNullValuesIfNoRecordsFound>
        <connector>
            <targetReference>Any_records_found</targetReference>
        </connector>
        <filterLogic>1 AND (2 OR 3)</filterLogic>
        <filters>
            <field>RecordTypeId</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>accountRecordTypeId</elementReference>
            </value>
        </filters>
        <filters>
            <field>PersonMobilePhone</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>searchString</elementReference>
            </value>
        </filters>
        <filters>
            <field>PersonEmail</field>
            <operator>EqualTo</operator>
            <value>
                <elementReference>searchString</elementReference>
            </value>
        </filters>
        <object>Account</object>
        <outputReference>referrerOptions</outputReference>
        <queriedFields>Id</queriedFields>
        <queriedFields>Name</queriedFields>
    </recordLookups>
    <runInMode>SystemModeWithoutSharing</runInMode>
    <start>
        <locationX>650</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Is_mobile_in_valid_format</targetReference>
        </connector>
    </start>
    <status>Active</status>
    <variables>
        <name>accountRecordTypeId</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>displayMessage</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
    </variables>
    <variables>
        <name>RecordTypeDeveloperName</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>false</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>referralType</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
    <variables>
        <name>referrerOptions</name>
        <dataType>SObject</dataType>
        <isCollection>true</isCollection>
        <isInput>false</isInput>
        <isOutput>true</isOutput>
        <objectType>Account</objectType>
    </variables>
    <variables>
        <name>searchString</name>
        <dataType>String</dataType>
        <isCollection>false</isCollection>
        <isInput>true</isInput>
        <isOutput>false</isOutput>
    </variables>
</Flow>
