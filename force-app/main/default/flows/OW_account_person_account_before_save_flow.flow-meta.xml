<?xml version="1.0" encoding="UTF-8"?>
<Flow xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>52.0</apiVersion>
    <assignments>
        <name>Set_email_duplicate_check_to_email</name>
        <label>Set email duplicate check to email</label>
        <locationX>50</locationX>
        <locationY>695</locationY>
        <assignmentItems>
            <assignToReference>$Record.OW_email_duplicate_check__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Record.PersonEmail</elementReference>
            </value>
        </assignmentItems>
    </assignments>
    <assignments>
        <name>Set_timestamp</name>
        <label>Set timestamp</label>
        <locationX>50</locationX>
        <locationY>395</locationY>
        <assignmentItems>
            <assignToReference>$Record.OW_last_change_to_portal_account_field__c</assignToReference>
            <operator>Assign</operator>
            <value>
                <elementReference>$Flow.CurrentDateTime</elementReference>
            </value>
        </assignmentItems>
        <connector>
            <targetReference>Email_set_or_changed</targetReference>
        </connector>
    </assignments>
    <decisions>
        <description>Checks if this is a new record or if the email has been changed. If so, the email unique/duplicate check field requires an update.</description>
        <name>Email_set_or_changed</name>
        <label>Email set or changed</label>
        <locationX>182</locationX>
        <locationY>587</locationY>
        <defaultConnectorLabel>No change</defaultConnectorLabel>
        <rules>
            <name>Email_changed</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>is_new</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.PersonEmail</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Set_email_duplicate_check_to_email</targetReference>
            </connector>
            <label>Email changed</label>
        </rules>
    </decisions>
    <decisions>
        <description>Checks whether any of the fields requiring sync for portal integrity have been updated and records the time of the action if so. New records also trigger this since they will be syncing for the first time and last name is always required on them.</description>
        <name>Portal_account_field_changed</name>
        <label>Portal account field changed?</label>
        <locationX>182</locationX>
        <locationY>287</locationY>
        <defaultConnector>
            <targetReference>Email_set_or_changed</targetReference>
        </defaultConnector>
        <defaultConnectorLabel>No</defaultConnectorLabel>
        <rules>
            <name>Yes</name>
            <conditionLogic>or</conditionLogic>
            <conditions>
                <leftValueReference>is_new</leftValueReference>
                <operator>EqualTo</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.FirstName</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.LastName</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.FinServ__PreferredName__pc</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.PersonEmail</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <conditions>
                <leftValueReference>$Record.Intelligent_Office_ID__c</leftValueReference>
                <operator>IsChanged</operator>
                <rightValue>
                    <booleanValue>true</booleanValue>
                </rightValue>
            </conditions>
            <connector>
                <targetReference>Set_timestamp</targetReference>
            </connector>
            <label>Yes</label>
        </rules>
    </decisions>
    <description>Will run for all accounts but terminate immediately for non-person accounts. Before save flow for quick updates.</description>
    <environments>Default</environments>
    <formulas>
        <description>Returns true if the record is new.</description>
        <name>is_new</name>
        <dataType>Boolean</dataType>
        <expression>ISNEW()</expression>
    </formulas>
    <interviewLabel>Account - person account before save flow {!$Flow.CurrentDateTime}</interviewLabel>
    <label>Account - person account before save flow</label>
    <processMetadataValues>
        <name>BuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>CanvasMode</name>
        <value>
            <stringValue>AUTO_LAYOUT_CANVAS</stringValue>
        </value>
    </processMetadataValues>
    <processMetadataValues>
        <name>OriginBuilderType</name>
        <value>
            <stringValue>LightningFlowBuilder</stringValue>
        </value>
    </processMetadataValues>
    <processType>AutoLaunchedFlow</processType>
    <start>
        <locationX>56</locationX>
        <locationY>0</locationY>
        <connector>
            <targetReference>Portal_account_field_changed</targetReference>
        </connector>
        <filterLogic>and</filterLogic>
        <filters>
            <field>IsPersonAccount</field>
            <operator>EqualTo</operator>
            <value>
                <booleanValue>true</booleanValue>
            </value>
        </filters>
        <object>Account</object>
        <recordTriggerType>CreateAndUpdate</recordTriggerType>
        <triggerType>RecordBeforeSave</triggerType>
    </start>
    <status>Active</status>
</Flow>
